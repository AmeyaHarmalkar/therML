# Supervised Convolutional Neural Network models

### Training Data

The TS50 Dataset assembled from multiple germlines were used for training. Test datasets comprised of scFv sequences from a different germline sequence and were held-out. The training sequence data is the intellectual property of Amgen Research and will not be released in this repository. 


### Requirements

Before running, several dependencies need to be installed:

- `pytorch`
- `DeepAb` structure prediction software available via RosettaCommons-DL. (Please check RosettaCommons for Rosetta and DeepAb licensing.)
- `torchmetrics`


### Preprocessing

This network requires some preprocessing steps. The scripts to perform the necessary pre-processing is in the `./preprocessing` folder. For each sequence in the fasta file, the scFv structure (in this case the Fv structure) could be generated by using an Antibody Structure prediction tool. In this study, we used DeepAb (Ruffolo et. al) for generating the structures and then utilized these structures for energetic calculations. 

**Energetic calculations:** To determine the energies from the structures, each structure was first relaxed with constraints (constrained to start coords for less deviations from the predicted structure, but also to optimize for energy). Further, the residue-wise energies were determined from residue energy breakdown. The XML and Rosetta executables required for energy generation are located in the `./preprocessing/Rosetta` directory. 

With the energetic calculations being done, the `generate_pairwise_file.py` can collate all the sequence and energy data, in 1D and 2D matrices format respectively, and store it in the H5PY file. This file would be employed for further training throughout. 

For Sequence design, point or multi-point mutated sequences can be used to generate structures and the same procedure can be repeated for generating the required H5PY files. This is exaplained further with the example of the monoclonal Antibody ahead for sequence thermostability design.


### Training

Most of the training code is located in `./utility` folder. Training can be performed with the `python train_EquiCNN.py`. For generating ensembles of CNNS, we used different splits of training sets and ensembled them together. There are a bunch of arguments available, the important ones are listed here:

- `epochs` : Number of epochs for training (default=30)
- `save_file` : Name of the model to save after the last epoch
- `batch_size` : Number of scFv sequences per batch
- `ignore_seq` : Whether to ignore the sequence branch while training
- `ignore_energy` : Whether to ignore the energy branch while training
- `num_1d_blocks` : Number of 1D blocks in the sequence branch
- `num_2d_blocks` : Number of 2D blocks in the energy/concatenated branch
- `h5_file` : The name of the pre-processed H5PY file to use for training
- `train_split` : The proportion of the training data split
- `try_gpu` : To train on GPUs. Note that this network can be swiftly trained on CPUs as well.


## Sequence design

For sequence design, we use the anti-VEGF monoclonal antibody as the test case. This antibody was tested prior by two separate studies for improving binding enrichment, however, for a select few mutations, the melting temperatures (Tm) are available. As TS50 and Tm are both temperature sensitive measures, we extrapolated our model to test on this mutants. 

We first start with a computational deep mutational scan and then used DeepAb to generate structures for each of the point mutants in the DMS. The score files and fasta for the anti-VEGF G6 antibody are stored in `./design` directory. Once the necessary preprocessing is done (as instructured above for training), we could use the `./utility/predict_EquiCNN.py` script to use the ensemble of CNN model to predict whether a mutation would be in the top 70-bin or not. 

`predict_EquiCNN.py` will output a csv file with predictions for all the point mutants, and more thermostable mutants are those which lie in the top-most bin (i.e. above 70 C bin). This way we could use our method for designing sequences that can be more thermostable. 